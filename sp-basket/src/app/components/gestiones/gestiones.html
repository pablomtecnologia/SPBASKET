<div class="gestiones-container" *ngIf="authService.isAuthenticated()">

    <!-- HEADER ICON -->
    <div class="gestiones-icon" (click)="toggleDropdown()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <div class="badge" *ngIf="getBadgeCount() > 0">{{ getBadgeCount() }}</div>
    </div>

    <!-- DROPDOWN PANEL -->
    <div class="gestiones-dropdown" *ngIf="showDropdown" (click)="$event.stopPropagation()">
        <div class="dropdown-header">
            <h3>{{ isAdmin() ? 'Centro de Control' : 'Mis Notificaciones' }}</h3>
            <button class="close-btn" (click)="toggleDropdown()">√ó</button>
        </div>

        <!-- TABS -->
        <div class="tabs-header">
            <button class="tab-link" [class.active]="viewMode === 'reconocimientos'"
                (click)="switchTab('reconocimientos')">
                M√©dicos
                <span class="tab-badge"
                    *ngIf="reconocimientosPendientes.length">{{reconocimientosPendientes.length}}</span>
            </button>
            <button class="tab-link" [class.active]="viewMode === 'papeletas'" (click)="switchTab('papeletas')">
                Papeletas
                <span class="tab-badge" *ngIf="papeletasPendientes.length">{{papeletasPendientes.length}}</span>
            </button>
        </div>

        <div class="dropdown-body">

            <!-- LISTA RECONOCIMIENTOS -->
            <div *ngIf="viewMode === 'reconocimientos'">
                <div *ngIf="reconocimientosPendientes.length === 0" class="empty-message">
                    Sin notificaciones
                </div>
                <div class="gestion-item" *ngFor="let rec of reconocimientosPendientes">
                    <div class="item-info">
                        <strong>{{ isAdmin() ? (rec.nombre + ' ' + rec.apellido) : 'Reconocimiento M√©dico' }}</strong>
                        <span>{{ rec.fecha_subida | date:'shortDate' }}</span>
                        <a [href]="rec.archivo_url" target="_blank" class="link-doc">Ver PDF</a>
                    </div>

                    <!-- ADMIN -->
                    <div class="item-actions" *ngIf="isAdmin()">
                        <button class="btn-approve" (click)="abrirModal(rec, 'validar')" title="Aprobar">‚úì</button>
                        <button class="btn-reject" (click)="abrirModal(rec, 'rechazar')" title="Rechazar">‚úï</button>
                    </div>

                    <!-- USER -->
                    <div class="item-actions" *ngIf="!isAdmin()">
                        <span
                            [style.background]="rec.estado=='validado'?'#d4edda':(rec.estado=='rechazado'?'#f8d7da':'#fff3cd')"
                            [style.color]="rec.estado=='validado'?'#155724':(rec.estado=='rechazado'?'#721c24':'#856404')"
                            style="padding:4px 8px; border-radius:4px; font-weight:bold; font-size:0.8rem; text-transform:uppercase;">
                            {{ rec.estado }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- LISTA PAPELETAS -->
            <div *ngIf="viewMode === 'papeletas'">
                <div *ngIf="papeletasPendientes.length === 0" class="empty-message">
                    Sin notificaciones
                </div>
                <div class="gestion-item" *ngFor="let p of papeletasPendientes">
                    <div class="item-info">
                        <strong>{{ isAdmin() ? (p.nombre + ' ' + p.apellidos) : 'Tal√≥n Papeletas' }}</strong>
                        <span style="font-size: 11px; color:#888;">Only {{ p.fecha_subida | date:'shortDate' }}</span>
                        <div style="font-size: 11px; margin-top: 4px;">
                            <span *ngIf="p.pagado"
                                style="color: #0ca678; font-weight: bold; background: #e6fcf5; padding: 2px 6px; border-radius: 4px;">üí∞
                                ABONADO</span>
                            <span *ngIf="!p.pagado"
                                style="color: #f59f00; font-weight: bold; background: #fff9db; padding: 2px 6px; border-radius: 4px;">‚è≥
                                NO PAGADO</span>
                        </div>
                        <button
                            style="border:none; background:none; color:#3498db; text-decoration:underline; cursor:pointer; font-size:12px; margin-top:2px; padding:0; text-align:left;"
                            (click)="verFoto(p.foto_url)">
                            üì∑ Ver Foto
                        </button>
                    </div>

                    <!-- ADMIN -->
                    <div class="item-actions" *ngIf="isAdmin()">
                        <button class="btn-approve" (click)="validarPapeleta(p, 'validado')" title="Aprobar">‚úì</button>
                        <button class="btn-reject" (click)="validarPapeleta(p, 'rechazado')" title="Rechazar">‚úï</button>
                    </div>

                    <!-- USER -->
                    <div class="item-actions" *ngIf="!isAdmin()"
                        style="display:flex; flex-direction:column; align-items:flex-end;">
                        <span
                            [style.background]="p.estado=='validado'?'#d4edda':(p.estado=='rechazado'?'#f8d7da':'#fff3cd')"
                            [style.color]="p.estado=='validado'?'#155724':(p.estado=='rechazado'?'#721c24':'#856404')"
                            style="padding:4px 8px; border-radius:4px; font-weight:bold; font-size:0.8rem; text-transform:uppercase;">
                            {{ p.estado }}
                        </span>
                        <button *ngIf="p.estado === 'validado' && !p.pagado" (click)="irAPagar()"
                            style="margin-top:5px; background:#667eea; color:white; border:none; padding:6px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                            üí≥ PAGAR
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" *ngIf="showModal" (click)="cerrarModal()">
        <div class="modal-card" (click)="$event.stopPropagation()">
            <!-- Contenido modal -->
            <h4 style="margin-top:0;">Confirmar Acci√≥n</h4>
            <p>¬ø{{ accionSeleccionada === 'validar' ? 'Aprobar' : 'Rechazar' }} documento {{
                selectedReconocimiento?.nombre ? 'de ' + selectedReconocimiento?.nombre : '' }}?</p>

            <textarea [(ngModel)]="mensajeAdmin" placeholder="Motivo (opcional)" class="form-control"
                style="width: 100%; margin: 10px 0; border: 1px solid #ddd; padding:8px; border-radius:6px; min-height:80px;"></textarea>

            <div class="modal-actions" style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                <button (click)="cerrarModal()" style="background:#f1f3f5; color:#495057;">Cancelar</button>
                <button (click)="procesarAccion()"
                    [style.background]="accionSeleccionada === 'validar' ? '#0ca678' : '#fa5252'" style="color:white;">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>