<div class="perfil-container">
    <div class="perfil-card">

        <!-- Header con Avatar -->
        <div class="perfil-header">
            <div class="avatar-container">
                <img *ngIf="user.avatar" [src]="user.avatar" alt="Avatar" class="avatar-img">
                <div *ngIf="!user.avatar" class="avatar-placeholder">{{ getInitials() }}</div>

                <!-- Bot√≥n de c√°mara superpuesto -->
                <label class="avatar-edit-btn" [class.loading]="uploadingAvatar">
                    <input type="file" (change)="onAvatarSelected($event)" accept="image/*" hidden>
                    <span *ngIf="!uploadingAvatar">üì∑</span>
                    <span *ngIf="uploadingAvatar" class="spinner-mini"></span>
                </label>
            </div>

            <h2 class="perfil-title">{{ user.nombre }} {{ user.apellidos }}</h2>
            <p class="perfil-role">
                <span class="role-badge" [ngClass]="user.rol">{{ user.rol | titlecase }}</span>
            </p>
        </div>

        <div class="messages-area">
            <div class="alert alert-success" *ngIf="successMessage">{{ successMessage }}</div>
            <div class="alert alert-error" *ngIf="errorMessage">{{ errorMessage }}</div>
        </div>

        <!-- Formulario -->
        <div class="perfil-form">
            <h3 class="section-title">Informaci√≥n Personal</h3>

            <div class="form-row">
                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" [(ngModel)]="user.nombre" placeholder="Nombre">
                </div>
                <div class="form-group">
                    <label>Apellidos</label>
                    <input type="text" [(ngModel)]="user.apellidos" placeholder="Apellidos">
                </div>
            </div>

            <div class="form-group">
                <label>Email <small>(Contacto)</small></label>
                <input type="email" [(ngModel)]="user.email" placeholder="email@ejemplo.com">
            </div>

            <div class="form-group">
                <label>Tel√©fono</label>
                <input type="tel" [(ngModel)]="user.telefono" placeholder="+34 600 000 000">
            </div>

            <h3 class="section-title mt-4">Datos de Club</h3>

            <div class="form-row">
                <div class="form-group locked">
                    <label>Usuario üîí</label>
                    <input type="text" [value]="user.username" disabled title="No se puede cambiar el usuario">
                </div>
                <div class="form-group locked">
                    <label>Licencia üîí</label>
                    <input type="text" [value]="user.licencia || 'Sin licencia asignada'" disabled>
                </div>
            </div>

            <!-- Gesti√≥n de Cuenta -->
            <h3 class="section-title mt-4">Gesti√≥n de Cuenta</h3>
            <div class="account-actions" style="margin-bottom: 20px;">
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">
                    Si deseas cambiar tu contrase√±a, te enviaremos un enlace de confirmaci√≥n a tu email.
                </p>
                <button type="button" class="btn-change-password" (click)="requestPasswordChange()"
                    [disabled]="loading">
                    üì© Cambiar Contrase√±a por Email
                </button>
            </div>

            <!-- Configuraci√≥n App -->
            <h3 class="section-title mt-4">Configuraci√≥n de la App</h3>
            <div class="settings-list">

                <!-- Dark Mode -->
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-label">Modo Oscuro</span>
                        <span class="setting-desc">Interfaz con colores oscuros</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" (change)="toggleDarkMode($event)" [checked]="isDarkMode">
                        <span class="slider round"></span>
                    </label>
                </div>

                <!-- Notificaciones -->
                <div class="setting-item">
                    <div class="setting-info">
                        <span class="setting-label">Notificaciones Email</span>
                        <span class="setting-desc">Recibir novedades y noticias</span>
                    </div>
                    <label class="switch">
                        <input type="checkbox" checked>
                        <span class="slider round"></span>
                    </label>
                </div>

                <!-- Descargar Datos -->
                <div class="setting-item clickable" (click)="downloadData()">
                    <div class="setting-info">
                        <span class="setting-label">Mis Datos</span>
                        <span class="setting-desc">Descargar copia de seguridad (GDPR)</span>
                    </div>
                    <div class="setting-action">‚¨áÔ∏è</div>
                </div>

            </div>

            <!-- Zona de Peligro -->
            <div class="danger-zone mt-4">
                <h4 class="danger-title">Zona de Peligro</h4>
                <p class="danger-desc">Una vez elimines tu cuenta, no hay vuelta atr√°s. Por favor, aseg√∫rate.</p>
                <button type="button" class="btn-delete-account" (click)="deleteAccount()">
                    üóëÔ∏è Eliminar mi Cuenta
                </button>
            </div>

            <!-- Botones Acci√≥n -->
            <div class="form-actions">
                <button class="btn-save" [disabled]="!hasChanges || loading" (click)="saveChanges()">
                    <span *ngIf="!loading">Guardar Cambios</span>
                    <span *ngIf="loading" class="spinner"></span>
                </button>
            </div>
        </div>

        <!-- SECCI√ìN BOT√ìN HISTORIAL -->
        <hr class="separator" style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

        <div class="historial-cta" style="text-align:center; padding: 0 30px 40px 30px;">
            <h3 style="margin-bottom:10px; color:#555; font-size:1.1rem;">Mis Tr√°mites</h3>
            <p style="color:#888; margin-bottom:20px; font-size:0.95rem;">
                Consulta el estado de tus reconocimientos m√©dicos, pagos de loter√≠a y descarga tus facturas.
            </p>
            <button (click)="verHistorial()" class="btn-ver-historial">
                üìÇ Ver Historial de Gestiones
            </button>
        </div>

    </div>

    <!-- Modal Ver Datos -->
    <div class="modal-backdrop" *ngIf="showUserDataModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Mis Datos Personales</h3>
                <button class="close-btn" (click)="closeDataModal()">‚úñ</button>
            </div>
            <div class="modal-body">
                <div class="data-row"><strong>ID:</strong> <span>{{user.id}}</span></div>
                <div class="data-row"><strong>Usuario:</strong> <span>{{user.username}}</span></div>
                <div class="data-row"><strong>Nombre:</strong> <span>{{user.nombre}}</span></div>
                <div class="data-row"><strong>Apellidos:</strong> <span>{{user.apellidos}}</span></div>
                <div class="data-row"><strong>Email:</strong> <span>{{user.email}}</span></div>
                <div class="data-row"><strong>Tel√©fono:</strong> <span>{{user.telefono || 'No registrado'}}</span></div>
                <div class="data-row"><strong>Rol:</strong> <span>{{user.rol}}</span></div>
                <div class="data-row"><strong>Licencia:</strong> <span>{{user.licencia || 'N/A'}}</span></div>
                <div class="data-code">
                    <pre>{{ user | json }}</pre>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" (click)="closeDataModal()">Cerrar</button>
            </div>
        </div>
    </div>
</div>