<div class="fan-zone-page fade-in">
    <div class="container">
        <h1 class="text-center section-title fade-in-up">ZONA FAN SP BASKET</h1>
        <p class="text-center mb-5 fade-in-up">Tu espacio exclusivo. Juega, participa y gana.</p>

        <!-- AUTH LOCK (DISABLED TEMPORARILY) -->
        <!-- 
        <div *ngIf="!isLoggedIn" class="locked-overlay fade-in">
            <div class="lock-content">
                <span class="lock-icon">üîí</span>
                <h2>Acceso Solo para Fans</h2>
                <p>Reg√≠strate para competir en el SP Runner, votar en la Quiniela y coleccionar puntos.</p>
                <a routerLink="/login" class="btn btn-primary btn-lg mt-3">ENTRAR AL CLUB</a>
            </div>
        </div>
        -->

        <div class="fan-dashboard">

            <!-- TEAM TOGGLER -->
            <div class="team-switcher-container text-center mb-4">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-team-toggle" [class.active]="currentTeam === 'rosa'"
                        (click)="switchTeam('rosa')">
                        SP ROSA
                    </button>
                    <button type="button" class="btn btn-team-toggle" [class.active]="currentTeam === 'negro'"
                        (click)="switchTeam('negro')">
                        SP NEGRO
                    </button>
                </div>
            </div>

            <!-- LAYOUT GRID -->
            <div class="dashboard-grid">

                <!-- 1. SP RUNNER GAME (Featured) -->
                <div class="card-widget runner-widget span-col-2">
                    <div class="widget-header">
                        <span class="widget-icon">üèÉ‚Äç‚ôÇÔ∏è</span>
                        <h3>SUPER BASKET MARIO</h3>
                        <span class="badge-new">NUEVO</span>
                    </div>
                    <div class="widget-body text-center">
                        <div *ngIf="activeTab !== 'runner'" class="runner-preview">
                            <p>¬°Salta con el logo de tu equipo y esquiva a los rivales!</p>
                            <div class="high-score-display">R√©cord: {{ highScoreRunner }}</div>
                            <button class="btn btn-primary btn-play pulse" (click)="showGame('runner')">JUGAR
                                AHORA</button>
                        </div>

                        <!-- GAME CONTAINER -->
                        <div *ngIf="activeTab === 'runner'" class="game-viewport">
                            <canvas #runnerCanvas width="800" height="400"></canvas>
                            <div class="mt-2 text-center text-muted small">Usa ESPACIO o CLICK para saltar</div>
                            <button class="btn btn-outline-light btn-sm mt-2" (click)="backToDashboard()">Salir</button>
                        </div>
                    </div>
                </div>

                <!-- 2. QUINIELA SEMANAL (Filtered by Team) -->
                <div class="card-widget quiniela-widget">
                    <div class="widget-header">
                        <span class="widget-icon">üìù</span>
                        <h3>La Quiniela {{ currentTeam | titlecase }}</h3>
                    </div>
                    <div class="widget-body">
                        <ng-container *ngFor="let q of quinielas">
                            <div *ngIf="q.team === currentTeam" class="quiniela-match-block mb-4 fade-in">
                                <p class="text-muted mb-1" style="font-size: 0.9rem;">
                                    <strong>{{q.competition}}</strong> <br> {{q.date}}
                                </p>
                                <div class="match-prediction">
                                    <div class="team">
                                        <img [src]="q.logoHome" alt="Home" class="mini-logo">
                                        <span>{{q.home}}</span>
                                        <input type="number" [(ngModel)]="q.prediction.home" [disabled]="q.submitted"
                                            class="score-input">
                                    </div>
                                    <span class="vs">VS</span>
                                    <div class="team">
                                        <img [src]="q.logoVisitor" alt="Visitor" class="mini-logo">
                                        <span>{{q.visitor}}</span>
                                        <input type="number" [(ngModel)]="q.prediction.visitor" [disabled]="q.submitted"
                                            class="score-input">
                                    </div>
                                </div>
                                <button *ngIf="!q.submitted" class="btn btn-outline-primary btn-block mt-2"
                                    (click)="submitQuiniela(q)">Enviar Pron√≥stico</button>
                                <div *ngIf="q.submitted" class="success-msg mt-2 fade-in">
                                    ‚úÖ ¬°Pron√≥stico guardado!
                                </div>
                            </div>
                        </ng-container>
                        <div *ngIf="!currentQuiniela" class="text-center text-muted">
                            No hay partido disponible para esta semana.
                        </div>
                    </div>
                </div>

                <!-- 3. MVP POLL (Filtered by Team) -->
                <div class="card-widget poll-widget">
                    <div class="widget-header">
                        <span class="widget-icon">‚≠ê</span>
                        <h3>MVP {{ currentTeam | titlecase }}</h3>
                    </div>
                    <div class="widget-body">
                        <div *ngIf="!mvpVoted">
                            <p class="mb-3">¬øQui√©n fue el mejor de {{ currentTeam === 'rosa' ? 'SP Rosa' : 'SP Negro'
                                }}?</p>
                            <div class="poll-options">
                                <label *ngFor="let player of filteredMvpCandidates" class="poll-option fade-in">
                                    <input type="radio" name="mvp" [value]="player.name" [(ngModel)]="selectedMvp">
                                    <img [src]="player.avatar" class="poll-avatar">
                                    <div class="poll-info">
                                        <span class="poll-name">{{ player.name }}</span>
                                        <span class="poll-team">{{ player.team }}</span>
                                    </div>
                                </label>
                            </div>
                            <div *ngIf="filteredMvpCandidates.length === 0" class="text-center">Cargando candidatos...
                            </div>
                            <button class="btn btn-primary btn-sm mt-3" (click)="voteMvp()"
                                [disabled]="!selectedMvp">Votar MVP</button>
                        </div>

                        <div *ngIf="mvpVoted" class="poll-results fade-in">
                            <h4>Resultados:</h4>
                            <div class="result-bar-container" *ngFor="let p of mvpResults">
                                <span class="label">{{ p.player_name }}</span>
                                <div class="progress">
                                    <div class="bar" [style.width.%]="getVotePercentage(p.player_name)"></div>
                                </div>
                                <small>{{ getVotePercentage(p.player_name) | number:'1.0-0' }}%</small>
                            </div>
                            <p class="text-muted mt-2 text-small">Gracias por tu voto.</p>
                        </div>
                    </div>
                </div>

                <!-- 4. MEMORY GAME -->
                <div class="card-widget memory-widget span-col-2">
                    <div class="widget-header">
                        <span class="widget-icon">üß†</span>
                        <h3>SP Memory Challenge</h3>
                    </div>
                    <div class="widget-body text-center">
                        <div *ngIf="activeTab !== 'memory'">
                            <p>Encuentra las parejas de iconos de baloncesto.</p>
                            <button class="btn btn-outline-light" (click)="showGame('memory')">JUGAR MEMORY</button>
                        </div>

                        <div *ngIf="activeTab === 'memory'">
                            <div class="game-info-bar mb-3">
                                <span>Movimientos: <strong>{{ moves }}</strong></span>
                                <button class="btn btn-sm btn-outline-light"
                                    (click)="resetMemoryGame()">Reiniciar</button>
                                <button class="btn btn-sm btn-link text-white"
                                    (click)="backToDashboard()">Cerrar</button>
                            </div>

                            <div class="memory-grid mb-3" *ngIf="!memoryGameWon; else winner">
                                <div class="memory-card" *ngFor="let card of memoryCards"
                                    [class.flipped]="card.flipped || card.matched" (click)="flipCard(card)">
                                    <div class="card-inner">
                                        <div class="card-front">
                                            <img src="assets/images/logo-sp-pink.png" alt="SP" class="card-logo">
                                        </div>
                                        <div class="card-back">{{ card.icon }}</div>
                                    </div>
                                </div>
                            </div>

                            <ng-template #winner>
                                <div class="winner-box text-center fade-in">
                                    <h3>üéâ ¬°COMPLETADO! üéâ</h3>
                                    <p>Has terminado en {{ moves }} movimientos.</p>
                                    <p class="text-neon" *ngIf="isLoggedIn">Puntuaci√≥n guardada</p>
                                    <button class="btn btn-primary" (click)="resetMemoryGame()">Jugar Otra Vez</button>
                                </div>
                            </ng-template>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>